# Chapter 2: Malware Analysis in Virtual Machines
## Learning Points
* Malware Analysis requires a safe environment
  * Use dedicated physical or virtual machines
    * Problem with physical machine is it can be difficult to remove malware
      * Can use disk imager to solve this
    * Advantage of physical machine is malware may behave differently in a VM
  * Use air-gapped networks
    * Can be a problem as it has no Internet access
* Virtual machines are most commonly used for malware analysis
  * The book uses VMWare, but I'll try VirtualBox
    * Some of the features needed (like snapshots) are only available in the paid version of VMWare, but come for free on VirualBox.
    * I'm familiar with VirtualBox
  * The book installs WindowsXP and I've heard some of the labs only work on XP
    * I'll try things on a Windows 10 VM, and use XP only when necessary
    * Most of the malware in the book is 32-bit (apart from [Chapter 21](./chapter-21.md)) so for XP I'll use this [32-bit iso](https://archive.org/details/WinXPProSP3x86), but I can't be sure it's 100% virus free!
  * To stop leaking malware over the network you can disable networking, but this means you can't analyze network activity
  * You can use host-only networking that sets up a private LAN between the guest and the host
  * In VMWare, you can set up a VM Team, that allows you to have a separate network between two or more VMs
    * In VirtualBox this can also be done using the Tools panel in the VM manager, and selecting Network from the list icon
      * Set up a new host-network and connect all VMs to that.
    * One of the machines should provide network services (DNS, HTTP server) to 'fool' the malware (see [Chapter 3](./chapter-3.md) for tools to emulate a network)
  * Don't connect the VM to the actual internet unless you have performed analysis on the malware first and know what it's going to do
  * If you need to connect to the internet, you can use the bridged network connection or network address translation (NAT) modes of the VM
  * Make sure to take snapshots of the clean VM
    * You can take further snapshots to switch between analysis of different malwares
  * Some malware can detect that it's on a VM, and may execute differently (see [Chapter 17](./chapter-17.md) for more details)
  * There's always a risk when analysing malware, even on a VM, so don't perform on a critical machine
  * Move notes, screenshots and other analysis files out of the VM using the Drag and Drop feature
  * Update the clean image with new tools as necessary and take anew snapshot
* Running dynamic malware analysis on a VM:
  * Start with a clean snapshot with no malware running on it
  * Transfer the malware to the VM
  * Conduct the analysis on the VM
  * Take your notes, screenshots and data from the VM and transfer to the physical machine
  * Revert the virtual machine to a clean snapshot


## Tools
* [How to install Windows 10 in a VM](https://www.extremetech.com/computing/198427-how-to-install-windows-10-in-a-virtual-machine): Instructions on installing Windows 10 in a VM - includes download instruction
* [VirtualBox](https://www.virtualbox.org/): x86 and AMD64 virtualization platform
* [VMWare Workstation Player](https://www.vmware.com/uk/products/workstation-player.html): Easily run multiple operating systems as virtual machines on your Windows or Linux PC with VMware Workstation Player (free for personal use)
* [VMWare Workstation Pro](https://www.vmware.com/uk/products/workstation-pro.html): Run Windows, Linux and BSD virtual machines on a Windows or Linux desktop with VMware Workstation Pro, the industry standard desktop hypervisor (paid version)
* [Windows 10 download](https://www.microsoft.com/en-gb/software-download/windows10): Where to get a Windows 10 download or the ISO creation tool (see How To link above for more details)
* [Windows XP download (32-bit)](https://archive.org/details/WinXPProSP3x86): An ISO for Windows XP - I don't know the provenance of this so beware!

## Labs
There were no labs for this chapter.
